<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zerody.user.mapper.UserOpinionMapper" >
  <resultMap id="BaseResultMap" type="com.zerody.user.domain.UserOpinion" >
    <id column="Id" property="id" jdbcType="VARCHAR" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="video" property="video" jdbcType="VARCHAR" />
    <result column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="deleted" property="deleted" jdbcType="INTEGER" />
  </resultMap>

  <resultMap id="BaseResultMapVo" type="com.zerody.user.vo.UserOpinionPageVo" extends="BaseResultMap">
    <result column="reply_content" property="replyContent" jdbcType="VARCHAR"/>
  </resultMap>

  <resultMap id="BaseResultMapPageVo" type="com.zerody.user.vo.UserOpinionPageVo" extends="BaseResultMapVo">
    <result column="company_name" property="companyName" jdbcType="VARCHAR"/>
    <result column="depart_name" property="departName" jdbcType="VARCHAR"/>
  </resultMap>

  <select id="queryUserOpinionUser" resultMap="BaseResultMapVo">
    select o.*,
    (SELECT content from user_reply r where r.opinion_id = o.id ORDER BY r.create_time desc limit 1 ) as reply_content
    from user_opinion o where o.user_id = #{userId} and o.deleted = 1
    order by o.create_time desc
  </select>

  <select id="getOpinionDetail" resultType="com.zerody.user.vo.UserOpinionDetailVo">
    select uo.*,sci.company_name, sdi.depart_name
    from user_opinion uo
    LEFT JOIN sys_staff_info ssi ON uo.user_id=ssi.user_id
    LEFT JOIN sys_company_info sci ON ssi.comp_id=sci.id
    LEFT JOIN union_staff_depart usd ON usd.staff_id = ssi.id
    LEFT JOIN sys_department_info sdi ON usd.department_id = sdi.id
    where uo.deleted = 1 and uo.id = #{id}
  </select>

  <select id="queryUserOpinionPage" resultMap="BaseResultMapVo" >
    select uo.*,sci.company_name, sdi.depart_name,
    (SELECT content from user_reply r where r.opinion_id = uo.id ORDER BY r.create_time desc limit 1 ) as reply_content
    from user_opinion uo
    LEFT JOIN sys_staff_info ssi ON uo.user_id=ssi.user_id
    LEFT JOIN sys_company_info sci ON ssi.comp_id=sci.id
    LEFT JOIN union_staff_depart usd ON usd.staff_id = ssi.id
    LEFT JOIN sys_department_info sdi ON usd.department_id = sdi.id
    where uo.deleted = 1
    order by uo.create_time desc
  </select>
</mapper>